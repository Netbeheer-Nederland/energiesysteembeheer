<!--             -->
<!-- OPMERKINGEN -->
<!--             -->

<div id="giscus-container">
    <p id="load-giscus-comments">
        <button type="button" name="button" class="btn fs-3" onclick="loadGiscusComments()">
            Toon opmerkingen
        </button>
    </p>
</div>

<script>
    function loadGiscusComments() {
        let header = '<h2 class="text-delta">Opmerkingen</h2>';
        let script = document.createElement('script');
        script.src = "https://giscus.app/client.js";
        script.async = true;
        script.crossOrigin = "anonymous";

        script.setAttribute("data-repo", "netbeheer-nederland/energiesysteembeheer");
        script.setAttribute("data-repo-id", "R_kgDOQbdEvg");
        script.setAttribute("data-category", "Announcements");
        script.setAttribute("data-category-id", "DIC_kwDOQbdEvs4Cy4mX");
        script.setAttribute("data-mapping", "pathname");
        script.setAttribute("data-strict", "1");
        script.setAttribute("data-reactions-enabled", "0");
        script.setAttribute("data-emit-metadata", "0");
        script.setAttribute("data-input-position", "bottom");
        script.setAttribute("data-theme", "light");
        script.setAttribute("data-lang", "nl");
        script.setAttribute("data-loading", "lazy");

        document.getElementById("giscus-container").replaceChild(script, document.getElementById('load-giscus-comments'));
    }
</script>

<!--                  -->
<!-- NAVIGATIE TOGGLE -->
<!--                  -->

<span id="skos-toggle-container" class="fw-500" style="display:none"> - <span class="text-purple-000" style="cursor:pointer" id="btn-toggle-nav">alfabatisch</span></span>

<ul id="skos-az-list" class="nav-list" style="display:none">
    <li id="skos-loading-container" class="nav-list-item">
        <span id="skos-loading-msg" class="nav-list-link">Laden...</span>
    </li>
</ul>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const sidebar = document.querySelector('.site-nav');
    const navCategory = document.querySelector('.nav-category');
    const originalList = document.querySelector('.site-nav > .nav-category + .nav-list');
    const azList = document.getElementById('skos-az-list');
    const toggleContainer = document.getElementById('skos-toggle-container');
    const btn = document.getElementById('btn-toggle-nav');
    const loadingContainer = document.getElementById('skos-loading-container');
    const loadingMsg = document.getElementById('skos-loading-msg');

    let dataLoaded = false;
    const jsonUrl = "{{ '/assets/begrippenlijst.json' | relative_url }}";

    function scrollToActive() {
      const activeLink = azList.querySelector('.active');
      if (activeLink) activeLink.scrollIntoView({block: 'center'}); 
    }

    function loadAndRenderData() {
      if (dataLoaded) return;

      fetch(jsonUrl)
        .then(response => response.json())
        .then(data => {
          const currentPath = window.location.pathname.replace(/\/$/, "");

          let listHTML = "";

          data.forEach(item => {
            const itemUrlClean = item.url.replace(/\/$/, "");
            const isActive = item.type !== 'alias' && (currentPath.endsWith(itemUrlClean) || itemUrlClean.endsWith(currentPath));
            let cssClass = 'nav-list-link';
            if (isActive) cssClass += ' active';

            let itemHTML = item.title;
            if (item.type === 'alias') itemHTML = '<span class="text-grey-dk-000">' + item.title + ' &rarr; </span>' + item.target_label;

            listHTML += '<li class="nav-list-item">';
            listHTML += '<a href="' + item.url + '" class="' + cssClass + '">' + itemHTML + '</a>';
            listHTML += '</li>';
          });

          azList.innerHTML = listHTML;
          loadingContainer.style.display = 'none';
          dataLoaded = true;
          scrollToActive();
        })
        .catch(err => {
          loadingMsg.textContent = "Fout bij laden begrippenlijst";
          console.error(err);
        });
    }

    function setNavMode(mode) {
      if (mode === 'az') {
        originalList.style.display = 'none';
        azList.style.display = 'block';
        btn.textContent = 'hiÃ«rarchisch';
        localStorage.setItem('skos-nav-pref', 'az');
        if (!dataLoaded) {
          loadAndRenderData(); 
        } else {
          scrollToActive();
        }
      } else {
        originalList.style.display = 'block';
        azList.style.display = 'none';
        btn.textContent = 'alfabetisch'; 
        localStorage.setItem('skos-nav-pref', 'tree');
      }
    }

    if (sidebar && navCategory && originalList && toggleContainer && azList) {
      navCategory.appendChild(toggleContainer);
      toggleContainer.style.display = 'inline';
      sidebar.insertBefore(azList, originalList);
      originalList.id = "skos-tree-list";

      const savedPref = localStorage.getItem('skos-nav-pref');
      if (savedPref === 'az') setNavMode('az');

      btn.addEventListener('click', function() {
        if (azList.style.display === 'none') {
          setNavMode('az');
        } else {
          setNavMode('tree');
        }
      });
    }
  });
</script>

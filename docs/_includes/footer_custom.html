<!--                      -->
<!-- GISCUS (opmerkingen) -->
<!--                      -->

<div id="giscus-container">
    <p id="load-giscus-comments">
        <button type="button" name="button" class="btn fs-3" onclick="loadGiscusComments()">
            Toon opmerkingen
        </button>
    </p>
</div>

<script>
    function loadGiscusComments() {
        let header = '<h2 class="text-delta">Opmerkingen</h2>';
        let script = document.createElement('script');
        script.src = "https://giscus.app/client.js";
        script.async = true;
        script.crossOrigin = "anonymous";

        script.setAttribute("data-repo", "netbeheer-nederland/energiesysteembeheer");
        script.setAttribute("data-repo-id", "R_kgDOQbdEvg");
        script.setAttribute("data-category", "Announcements");
        script.setAttribute("data-category-id", "DIC_kwDOQbdEvs4Cy4mX");
        script.setAttribute("data-mapping", "pathname");
        script.setAttribute("data-strict", "1");
        script.setAttribute("data-reactions-enabled", "0");
        script.setAttribute("data-emit-metadata", "0");
        script.setAttribute("data-input-position", "bottom");
        script.setAttribute("data-theme", "light");
        script.setAttribute("data-lang", "nl");
        script.setAttribute("data-loading", "lazy");

        document.getElementById("giscus-container").replaceChild(script, document.getElementById('load-giscus-comments'));
    }
</script>

<!--                -->
<!-- NAVIGATIEMODUS -->
<!--                -->

<!-- DE WISSELKNOP (standaard verborgen) -->
<span id="skos-toggle-container" class="fw-500"> - <a href="#" id="btn-toggle-nav">alfabatisch</a></span>

<!-- DE ALFABETISCHE LIJST (standaard verborgen) -->
<ul class="nav-list" id="skos-az-list" style="display: none;">
    <li class="nav-list-item" id="skos-loading-container">
        <span class="nav-list-link" id="skos-loading-msg">Laden...</span>
    </li>
</ul>

<!-- HET SCRIPT (zet alles op de juiste plek en regelt de klik) -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    /* Selecteer elementen */
    const sidebar = document.querySelector('.site-nav');
    const originalList = document.querySelector('.site-nav > .nav-category + .nav-list');
    const toggleContainer = document.getElementById('skos-toggle-container');
    const azList = document.getElementById('skos-az-list');
    const loadingContainer = document.getElementById('skos-loading-container');
    const loadingMsg = document.getElementById('skos-loading-msg');
    const btn = document.getElementById('btn-toggle-nav');

    /* Variabele om bij te houden of we de data al hebben */
    let dataLoaded = false;
    const jsonUrl = "{{ '/assets/begrippenlijst.json' | relative_url }}";

    /* Functie om JSON op te halen en te renderen */
    function loadAndRenderData() {
      if (dataLoaded) return; /* Al gedaan? Stop. */

      fetch(jsonUrl)
        .then(response => response.json())
        .then(data => {

          /* Huidige URL bepalen en normaliseren (laatste slash eraf) */
          const currentPath = window.location.pathname.replace(/\/$/, "");

          /* HTML bouwen */
          let html = "";

          data.forEach(item => {
            const itemUrlClean = item.url.replace(/\/$/, "");
            const isActive = currentPath.endsWith(itemUrlClean) || itemUrlClean.endsWith(currentPath);
            let cssClass = 'nav-list-link';
            if (isActive) {
              cssClass += ' active';
            }

            let htmlContent = item.title;
            let extraAttrs = "";

            if (item.type === 'alias') {
              /* Styling voor de alias zelf */
              extraAttrs = 'style="font-style: italic; color: #555;"';
              
              /* De pijl en de doelterm toevoegen */
              /* We gebruiken een <span> voor de doelterm om hem wat lichter/kleiner te maken */
              htmlContent += ' <span style="font-weight: normal; color: #999; font-size: 0.85em;">&rarr; ' + item.target_label + '</span>';
            }
            
            html += '<li class="nav-list-item">';
            html += '<a href="' + item.url + '" class="' + cssClass + '" ' + extraAttrs + '>' + htmlContent + '</a>';
            html += '</li>';
          });

          azList.innerHTML = html;
          loadingContainer.style.display = 'none'; /* Verberg 'Laden...' */
          dataLoaded = true;
        })
        .catch(err => {
          loadingMsg.textContent = "Fout bij laden begrippenlijst";
          console.error(err);
        });
    }

    /* Functie om de weergave te bepalen (en op te slaan) */
    function setNavMode(mode) {
      if (mode === 'az') {
        /* Weergave: A-Z */
        originalList.style.display = 'none';
        azList.style.display = 'block';
        btn.textContent = "hiërarchisch";
        localStorage.setItem('skos-nav-pref', 'az');
        loadAndRenderData();
      } else {
        /* Weergave: hiërarchie (boom) */
        originalList.style.display = 'block';
        azList.style.display = 'none';
        btn.textContent = "alfabetisch"; 
        localStorage.setItem('skos-nav-pref', 'tree');
      }
    }

    if (sidebar && originalList && toggleContainer && azList) {
      
      /* --- PLAATSING LOGICA --- */
      const navCategory = document.querySelector('.nav-category');
      navCategory.appendChild(toggleContainer);
      sidebar.insertBefore(azList, originalList);

      originalList.id = "skos-tree-list";

      /* --- GEHEUGEN CHECK --- */
      /* Kijk of er een voorkeur is opgeslagen. Zo niet, standaard 'tree'. */
      const savedPref = localStorage.getItem('skos-nav-pref');
      
      if (savedPref === 'az') {
        setNavMode('az');
      } else {
        setNavMode('tree');
      }

      /* --- KLIK EVENT --- */
      btn.addEventListener('click', function() {
        /* Check huidige status door naar display te kijken */
        if (azList.style.display === 'none') {
          setNavMode('az');
        } else {
          setNavMode('tree');
        }
      });
    }
  });
</script>
